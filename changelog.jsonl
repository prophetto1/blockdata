{"name": "prd_drafted", "entityType": "milestone", "observations": ["Initial PRD written for Block Inventory + User-Defined Schemas + Annotation Pipeline", "Covers core concepts, canonical record format, field reference, ingestion pipeline, annotation pipeline, error states, frontend requirements"], "timestamp": "2026-02-02T21:44:00Z"}
{"name": "prd_inconsistencies_identified", "entityType": "decision", "observations": ["Immutability rule too narrow - excluded schema_ref from changeable fields", "Annotation pipeline output implied all blocks filled - contradicted error states", "Section numbering gap between 2.3 and 8.1", "Schema binding described from two vantage points without distinct step"], "timestamp": "2026-02-02T21:48:00Z"}
{"name": "immutable_schema_ownership_fixed", "entityType": "decision", "observations": ["Immutable schemas are system-provided not user-defined", "Section 2.3 header corrected from 'both user-defined' to 'different sources; different orientations'", "Ingestion pipeline input corrected to 'user selection from system-provided immutable schemas'", "Frontend 9.1 corrected to 'Select immutable schema from system-provided options'"], "timestamp": "2026-02-02T22:06:00Z"}
{"name": "universal_envelope_confirmed", "entityType": "architecture", "observations": ["Envelope shape is identical across all document types", "immutable_schema_ref is classification label only not shape modifier", "All document-type-specific richness lives in annotation layer via swappable annotation schemas", "No schema-specific immutable fields, no extended key"], "timestamp": "2026-02-02T22:55:00Z"}
{"name": "docling_selected_for_ingest", "entityType": "integration", "observations": ["Docling (IBM, MIT license) selected as document parser for non-MD formats", "Pipeline: any format -> Docling -> .md -> remark-parse -> AST -> blocks", "Docling is separate utility outside core pipeline, not embedded in spec", "Markdown is the universal entry point to the pipeline"], "timestamp": "2026-02-02T22:16:00Z"}
{"name": "remark_parse_selected", "entityType": "integration", "observations": ["remark-parse (unified/remark ecosystem) selected as MD parser", "AST nodes provide position.start.offset and position.end.offset for char_span", "Node types map directly to block_type", "Tree structure provides section_path via heading nesting", "doc_title auto-extracted from first H1 heading, fallback to filename"], "timestamp": "2026-02-02T23:00:00Z"}
{"name": "backend_postgres_supabase", "entityType": "architecture", "observations": ["Chose Supabase/PostgreSQL over PocketBase/SQLite", "Blocks stored as database rows not JSONL files", "Row-level locking enables true concurrent AI annotation", "JSONL is export format generated on demand from DB", "Supabase project block-annotation created in us-west-1 project id dbdzzhshmigewyprahej"], "timestamp": "2026-02-02T22:38:00Z"}
{"name": "concurrent_annotation_pattern", "entityType": "architecture", "observations": ["Workers claim blocks via atomic UPDATE WHERE status=pending RETURNING *", "Each worker writes annotation.data back to claimed row", "Failed blocks move to failed with error recorded or revert to pending based on retry policy", "Frontend subscribes to block status changes via Supabase Realtime"], "timestamp": "2026-02-02T22:34:00Z"}
{"name": "export_branches_defined", "entityType": "architecture", "observations": ["JSONL file export for document revision, archival, portability", "KG ingest - extract triples/entities/relations from annotation.data -> graph DB", "Document reconstruction - extract content across blocks -> assemble .md -> Pandoc -> docx/pdf/html", "Docling in, Pandoc out, .md as pivot format both directions"], "timestamp": "2026-02-02T23:10:00Z"}
{"name": "prd_use_cases_fixed", "entityType": "decision", "observations": ["SC/Law Cases subsection corrected - law_case_v1 is classification label, same universal envelope", "KB/KG subsection corrected - kb_chunk_v1 is classification label, same universal envelope", "Removed language implying immutable schema changes envelope shape per document type"], "timestamp": "2026-02-02T23:15:00Z"}
{"name": "repo_initialized", "entityType": "milestone", "observations": ["MD-ANNOTATE repo created", "README.md written with pipeline overview, key ideas, and stack", "MD = markdown + metadata dual meaning"], "timestamp": "2026-02-02T23:30:00Z"}
{"name": "three_hash_identity_model", "entityType": "architecture", "observations": ["source_uid = SHA256(source_type + newline + raw_source_bytes) - identity of uploaded blob", "md_uid = SHA256(raw_markdown_bytes) - identity of Markdown used for ingest", "doc_uid = SHA256(immutable_schema_ref + newline + md_uid) - identity of document under a schema", "block_uid = SHA256(doc_uid + colon + block_index) - unchanged formula uses new doc_uid", "For .md uploads all three hashes computable immediately", "For non-MD uploads md_uid and doc_uid computed after conversion completes", "md_uid enables dedup across formats - converted docx matching uploaded md yields same md_uid", "Same Markdown under different immutable_schema_ref produces different doc_uid"], "timestamp": "2026-02-02T23:50:00Z"}
{"name": "docling_integrated_into_pipeline", "entityType": "decision", "observations": ["Docling upgraded from separate external utility to integrated pipeline component", "Upload accepts md docx pdf pptx txt - system handles conversion internally", "Format variety is a feature not a complication - users should not convert files themselves", "Replaces PRD v2 language that said users run Docling separately before upload"], "timestamp": "2026-02-02T23:52:00Z"}
{"name": "single_documents_table", "entityType": "decision", "observations": ["One documents table with source_uid md_uid and doc_uid columns - not two tables", "For .md uploads all columns populated in single request", "For non-MD uploads md_uid and doc_uid start NULL populated after conversion callback", "Two-table split (sources + documents) rejected as unnecessary complexity for Phase 1", "Can split later if lifecycle separation becomes operationally messy"], "timestamp": "2026-02-02T23:54:00Z"}
{"name": "service_architecture_boundary", "entityType": "architecture", "observations": ["Edge Functions (Deno/TS) own all database operations", "Python microservice (FastAPI) touches Supabase Storage only never Postgres", "Python authenticates via shared secret env var", "Edge Functions generate signed Storage URLs so Python needs no Supabase keys", "Conversion flow commits documents row before calling Python service to prevent race condition", "Callback carries source_uid as reference - doc_uid may not exist yet for non-MD"], "timestamp": "2026-02-02T23:56:00Z"}
{"name": "timeout_failure_handling", "entityType": "architecture", "observations": ["Edge Function sets configurable request timeout when calling Python service", "On timeout Edge Function immediately sets status=conversion_failed with error message", "pg_cron scheduled job catches stale converting rows older than 5 minutes as safety net", "Covers edge case where Edge Function crashes after calling Python but before handling timeout", "Error column added to documents table - TEXT NULL for human-readable failure messages"], "timestamp": "2026-02-02T23:58:00Z"}
{"name": "auth_rls_model", "entityType": "architecture", "observations": ["Writes via Edge Functions only using service role key", "Reads via authenticated user JWT with RLS policies checking owner_id", "Anon key not used for production reads - user authentication required", "No client-side inserts or updates ever - all mutations through Edge Functions", "Python microservice authenticates to Edge Function callbacks via shared secret"], "timestamp": "2026-02-03T00:00:00Z"}
{"name": "ddl_hardening_decisions", "entityType": "decision", "observations": ["source_uid md_uid doc_uid block_uid CHECK constraint matches 64-char hex pattern", "char_span elements nonnegative and start <= end", "block_index >= 0 constraint", "source_type CHECK IN md docx pdf pptx txt", "status CHECK IN uploaded converting ingested conversion_failed ingest_failed", "ON DELETE CASCADE on blocks -> documents", "Indexes on blocks(doc_uid) blocks(doc_uid block_index) documents(uploaded_at DESC)"], "timestamp": "2026-02-03T00:02:00Z"}
{"name": "prd_v3_produced", "entityType": "milestone", "observations": ["PRD updated from v2 to v3 incorporating all architecture decisions since backend section added", "Three-hash identity model with Identity Model section and Identity Behavior by Upload Type", "Docling integrated into pipeline with full conversion flow spec", "Timeout and failure handling with pg_cron stale cleanup", "Documents table redesigned with source_uid md_uid doc_uid status error md_locator", "Auth and RLS section added", "DDL hardening with CHECK constraints and indexes", "PK question flagged for DDL spec - doc_uid as PK vs source_uid as PK with doc_uid UNIQUE FK target"], "timestamp": "2026-02-03T00:05:00Z"}
{"name": "ddl_migration_001_deployed", "entityType": "milestone", "observations": ["Migration 001_phase1_immutable_documents_blocks applied to Supabase", "documents + blocks tables live with 13 CHECK constraints and 9 indexes", "RLS policies: documents_select_own, blocks_select_own (SELECT only, no client writes)", "Trigger set_documents_updated_at applied", "One advisory: set_updated_at function needs SET search_path = '' (minor security fix)"], "timestamp": "2026-02-03T00:10:00Z"}
{"name": "prd_v4_produced", "entityType": "milestone", "observations": ["PRD updated to v4 reflecting deployed DDL and Edge Function architecture", "Platform roadmap section drafted as companion document mapping capabilities to architectural primitives"], "timestamp": "2026-02-03T00:15:00Z"}
{"name": "edge_functions_phase1_deployed", "entityType": "milestone", "observations": ["Three Edge Functions live on Supabase project dbdzzhshmigewyprahej", "ingest (POST, JWT): .md path does full ingest in one request, non-md path fires async conversion", "conversion-complete (POST, API key auth): callback from Python service, idempotent with job_id guard", "export-jsonl (GET, JWT): RLS-enforced export with immutable envelope + empty annotation stub", "Shared modules: cors.ts, env.ts, hash.ts, markdown.ts, sanitize.ts, supabase.ts", "remark-parse integrated in markdown.ts for AST-based block extraction"], "timestamp": "2026-02-03T00:20:00Z"}
{"name": "platform_roadmap_defined", "entityType": "architecture", "observations": ["Three-tier product vision: Tool (Phase 1-2) -> Platform (Tier 2) -> Infrastructure (Tier 3)", "Phase 1: Upload -> blocks -> JSONL export (immutable inventory only)", "Phase 2: Multi-schema annotation via schemas + annotation_runs + block_annotations", "Tier 2: Visual schema builder, schema gallery, schema versioning - all additive to schemas table", "Tier 3: Export connectors, model adapters, event system, REST API", "Every capability grounded to specific tables/columns/patterns that already exist"], "timestamp": "2026-02-03T00:25:00Z"}
{"name": "learning_commons_inspiration", "entityType": "architecture", "observations": ["Learning Commons (CZI/Anthropic) identified as architectural inspiration", "Pattern: domain corpus -> structured entities -> relationship edges -> AI pipeline infrastructure", "LC atomic unit = learning component (standards-aligned skill), MD-ANNOTATE atomic unit = block (content-addressed paragraph)", "Both share: stable identity, structured extraction, schema-driven annotation, multi-destination export", "LC built for education domain; MD-ANNOTATE generalizes pattern to any document domain"], "timestamp": "2026-02-03T00:30:00Z"}
{"name": "granularity_flexibility_confirmed", "entityType": "architecture", "observations": ["Block as atomic unit is configurable at split time not hardcoded", "Splitter config driven by immutable_schema_ref classification label", "Examples: md_prose_v1 (paragraph), md_chapter_v1 (H1-level), legal_opinion_v1 (section-level)", "Higher-level units are views over blocks via section_path or block_index ranges", "Same envelope, same annotation overlay, same export branches - only splitting rule changes"], "timestamp": "2026-02-03T00:35:00Z"}
{"name": "edge_functions_gateway_jwt_verification_disabled_dev", "entityType": "decision", "observations": ["Redeployed Edge Functions `ingest` and `export-jsonl` with verify_jwt=false at the gateway layer to avoid gateway-level JWT rejection during development", "Authorization is still required and validated inside functions via Supabase Auth (`auth.getUser()`), which remains load-bearing for documents.owner_id", "Production plan: re-enable gateway JWT verification or implement explicit JWT verification against Supabase signing keys (JWKS) inside functions"], "timestamp": "2026-02-02T11:55:58Z"}
{"name": "smoke_test_md_ingest_export_passed", "entityType": "milestone", "observations": ["Smoke test succeeded end-to-end for .md ingest and JSONL export", "Ingested `json-schemas/prd-v4.md` and produced 216 blocks", "Export produced JSONL matching PRD contract shape with inert annotation placeholder (schema_ref null; data {})"], "timestamp": "2026-02-02T11:55:58Z"}
{"name": "smoke_test_script_secret_hygiene_hardened", "entityType": "decision", "observations": ["Updated `scripts/smoke-test.ps1` to avoid hardcoding credentials: prompts for email/password or uses TEST_EMAIL/TEST_PASSWORD env vars", "Added early validation for SUPABASE_URL/SUPABASE_ANON_KEY and added JWT diagnostics (Auth verification + Functions probe) to reduce debugging time"], "timestamp": "2026-02-02T11:55:58Z"}
{"name":"phase2_tables_deployed","entityType":"milestone","observations":["Applied Phase 2 DDL migration: `schemas`, `annotation_runs`, `block_annotations`","Added RPC `create_annotation_run(owner_id, doc_uid, schema_id)` to create a run and populate per-block rows atomically","Enabled RLS read policies for Phase 2 tables (SELECT only; writes via Edge Functions)"],"timestamp":"2026-02-02T12:10:00Z"}
{"name":"phase2_edge_functions_deployed","entityType":"milestone","observations":["Deployed Edge Function `schemas` (POST /schemas) for end-user schema upload","Deployed Edge Function `runs` (POST /runs) to create `annotation_runs` + populate `block_annotations` via RPC","Extended `export-jsonl` to support `run_id` (overlays per-block annotation data) in addition to `doc_uid` (Phase 1 placeholder)"],"timestamp":"2026-02-02T12:12:00Z"}
{"name":"repo_migrations_added","entityType":"milestone","observations":["Added `supabase/migrations/` to repo and reconstructed Phase 1 migration file from live DB state","Added Phase 2 migration file to repo to keep DDL under version control going forward","Added `json-schemas/ddl-plan.md` as a stable pointer to `json-schemas/complete/ddl-plan.md`"],"timestamp":"2026-02-02T12:14:00Z"}
{"name":"phase2_smoke_test_added","entityType":"milestone","observations":["Added Phase 2 scaffolding smoke test `scripts/smoke-test-schema-run.ps1` (ingest .md -> upload schema -> create run -> export JSONL by run_id)","Phase 2 export includes `annotation.schema_ref`, `annotation.schema_uid`, and per-block `annotation.data` (empty `{}` until a worker writes results)"],"timestamp":"2026-02-02T12:16:00Z"}
{"name":"phase2_smoke_test_run_create_body_fix","entityType":"decision","observations":["Adjusted `scripts/smoke-test-schema-run.ps1` to send the run-create JSON body via a temp file (`--data-binary @file`) to avoid PowerShell argument/encoding edge cases","Uses ASCII encoding for the temp file to avoid UTF-8 BOM JSON parse failures"],"timestamp":"2026-02-02T12:18:00Z"}
{"name":"ingest_idempotency_storage_upsert","entityType":"decision","observations":["Fixed Phase 1 ingest idempotency: repeated ingest of the same file no longer fails with Storage 'resource already exists'","`ingest` now short-circuits if `documents.source_uid` already exists and returns the existing status/doc_uid","Storage upload switched to `upsert: true` (safe because the object key is content-addressed by `source_uid`)"],"timestamp":"2026-02-02T12:30:00Z"}
{"name":"schema_upload_idempotent_by_ref","entityType":"decision","observations":["Made `POST /schemas` idempotent for repeated uploads","If `(owner_id, schema_ref)` already exists and `schema_uid` matches, the function returns the existing schema row (200) instead of erroring","If `schema_ref` exists but `schema_uid` differs, the function returns 409 conflict so schema versions are explicit"],"timestamp":"2026-02-02T12:34:00Z"}
{"name":"user_defined_schema_repo_location","entityType":"decision","observations":["Standardized on `json-schemas/user-defined/` as the repo location for example user-defined schemas","Updated `scripts/smoke-test-schema-run.ps1` to default to that folder (or `$env:SCHEMA_FILE`) when uploading a schema"],"timestamp":"2026-02-02T12:40:00Z"}
{"name":"schema_run_export_proof_saved","entityType":"milestone","observations":["Ran ingest + schema upload + run creation + export on `docs/test-pack/a2-v4.8-10787.docx.md` (347 blocks)","Saved canonical per-block JSON proof artifacts for selected blocks (5, 25, 100, 150, 250) under `docs/test-pack/` to validate export shape and frontend binding"],"timestamp":"2026-02-02T12:55:00Z"}
{"name":"smoke_test_runs_body_file_arg_fix","entityType":"decision","observations":["Fixed `scripts/smoke-test-schema-run.ps1` to pass JSON request body to curl using the `@file` syntax without quotes (`--data-binary @file`) so the `/runs` function receives valid JSON in PowerShell"],"timestamp":"2026-02-02T12:56:00Z"}
{"name":"ui_mockup_v2_overlays_column","entityType":"decision","observations":["Added a stronger UI mockup that matches the backend lifecycle: `ui/sample/blockdata-sample-mockup-v2.jsx`","Reframed the right column as overlays (runs) so it stays accurate before and after model integration (prepared vs processing vs complete)"],"timestamp":"2026-02-02T13:05:00Z"}
{"name":"ui_mockup_v3_dev_mode_runs","entityType":"decision","observations":["Added a dev-mode UI mockup that intentionally cues the model-connected direction while staying explicit that this environment is private: `ui/sample/blockdata-sample-mockup-v3.jsx`","Shows runs progressing (processing/complete) and calls out a worker loop concept (claim -> model -> complete) alongside always-available JSONL export"],"timestamp":"2026-02-02T13:10:00Z"}
{"name":"ui_nextjs_scaffold_added","entityType":"milestone","observations":["Scaffolded a real Next.js 14 App Router UI under `ui/` (TypeScript + Tailwind + shadcn-style primitives)","Pages: `/` (sign-in + upload/ingest + recent docs), `/documents/[source_uid]` (status + blocks + create run), `/schemas` (upload/list schemas), `/runs/[run_id]` (run detail + export overlay)","UI uses Supabase Auth + RLS reads and calls Edge Functions for ingest/schemas/runs/export"],"timestamp":"2026-02-02T13:25:00Z"}
{"name":"remark_mdast_retained_edge_runtime_reason","entityType":"decision","observations":["Keep Markdown->mdast parsing via remark inside Supabase Edge Functions (Deno) to avoid re-architecting parsing into a separate service.","mdast offsets (position.start/end.offset) are load-bearing for blocks.char_span, which supports future UX needs like highlighting/verification against the stored Markdown."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"pandoc_ast_parallel_pipeline_deferred","entityType":"decision","observations":["Do not replace remark/mdast with Pandoc AST in the core pipeline today (Pandoc cannot run in Edge Functions; Pandoc JSON AST does not provide equivalent source offsets for char_span).","Pandoc-based parsing may be added later as a separate parallel pipeline/service if needed for broader format coverage or richer structure."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"original_source_visibility_requirement_recorded","entityType":"decision","observations":["Treat source_locator (original upload bytes) as a first-class artifact for future schemas/workflows that require checking annotations against the original source.","Preserve md_locator + char_span so UI can reliably show block slices from the canonical Markdown used for ingest."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"conversion_callback_url_needs_functions_v1_path","entityType":"decision","observations":["Non-md end-to-end requires conversion service callbacks to hit the deployed Edge Function endpoint at /functions/v1/conversion-complete (not just /conversion-complete on the project origin).","Action: update ingest callback_url construction and keep the callback contract explicit in PRD/docs."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"frontend_stack_switched_to_sveltekit","entityType":"decision","observations":["Switched the frontend strategy from Next.js to a single SvelteKit app to improve solo-dev velocity and AI-assisted iteration.","Product shape remains the same: public marketing pages + auth-gated dashboard (/app/*).","Backend contract remains canonical: PostgREST reads under RLS; Edge Functions for ingest/schemas/runs/export."],"timestamp":"2026-02-03T09:00:00Z"}
{"name":"frontend_sveltekit_app_added","entityType":"milestone","observations":["Added the new primary frontend under `frontend/` (SvelteKit).","Implemented auth pages (/login, /logout) and protected dashboard routes under `/app/*`.","Implemented core dashboard flow pages: upload -> status -> blocks -> export, plus Phase 2 scaffolding pages for schemas and runs.","Added docs: ADR (`docs/refs/frontend-stack-decision.md`), migration guide, runbook, and routes/flows mapping under `docs/dev-plan/frontend/`."],"timestamp":"2026-02-03T09:30:00Z"}
{"name":"nextjs_ui_removed","entityType":"milestone","observations":["Removed the legacy Next.js UI directory (`ui/`) after the SvelteKit frontend was working.","Standardized frontend env vars on `PUBLIC_SUPABASE_URL` and `PUBLIC_SUPABASE_ANON_KEY` (SvelteKit public env convention).","Added Vercel static deploy support for the new frontend, including SPA deep-link fallback via `frontend/vercel.json` and documented deployment steps in `frontend/README.md`."],"timestamp":"2026-02-03T10:00:00Z"}
{"name":"changelog_retention_policy","entityType":"decision","observations":["Changelog entries are treated as an audit trail of decisions and milestones, not as a current spec.","When a previous entry becomes obsolete due to a confirmed design shift, we do not delete it by default; we add a new entry that explicitly calls it legacy/obsolete and points to updated canonical docs.","Deletion is reserved for truly invalid content (copied from another project, duplicate/noise entries, or entries that were flat-out wrong and provide no value as historical context).","This policy exists to prevent silent drift where important historical assumptions disappear without an explicit superseding record."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"ultimate_design_default_scope_locked","entityType":"decision","observations":["Default scope for PRD/spec conversations is now the intended (ultimate) design, not the current repo state.","When current implementation details are referenced, they are treated as legacy evidence only unless explicitly stated otherwise.","Goal: prevent drift caused by treating incomplete repo artifacts as authoritative design."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"ingestion_two_track_confirmed_doclingdocument_vs_mdast","entityType":"architecture","observations":["Confirmed the ingestion architecture is a hybrid two-track pipeline based on upload type.","Non-Markdown uploads (docx/pptx/pdf/html/images/xlsx/...): `source bytes -> Docling conversion -> DoclingDocument (JSON) -> block extraction`.","Markdown uploads (.md): `markdown bytes -> remark -> mdast -> block extraction`.","Rationale: mdast provides precise source offsets for Markdown; DoclingDocument preserves rich object categories (tables/pictures/headers/footnotes/forms/furniture) that are often lost when forcing everything through Markdown first.","This is a significant shift away from the earlier 'Markdown is the universal pivot' assumption (Docling -> Markdown -> mdast) for non-Markdown formats."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"legacy_markdown_pivot_for_non_md_reclassified","entityType":"decision","observations":["Earlier entries describing non-MD ingest as `Docling -> Markdown -> mdast -> blocks` are now considered legacy/obsolete design framing.","Remark/mdast is still valid and preferred for native Markdown uploads, but it is no longer mandatory as the universal representation for all formats.","DoclingDocument is now treated as an AST-like structured model that can directly support 'typed, ordered, end-to-end' block extraction for non-Markdown sources."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"immutable_envelope_vnext_naming_convention_canonicalized","entityType":"decision","observations":["Introduced and standardized the vNext immutable naming convention: `source_*` (pre-conversion), `conv_*` (post-conversion representation used to derive blocks), `block_*` (per-block immutable registry).","Legacy terms `doc_uid`, `md_uid`, `char_span`, `section_path`, and `annotation` are now explicitly treated as legacy naming only.","Canonical vNext envelope shape per exported block: `{ \"immutable\": { \"source_upload\": { ... }, \"conversion\": { ... }, \"block\": { ... } } }`.","The vNext immutable schema is unified across both ingestion tracks; it must be a normalized superset capable of representing both mdast-derived and DoclingDocument-derived blocks."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"conv_uid_definition_updated_to_match_converted_representation","entityType":"architecture","observations":["Defined `conversion.conv_uid` as the identity hash of the converted representation bytes that were parsed to produce the block inventory (not the uploaded source bytes).","Defined `conversion.conv_representation_type` as an explicit label to prevent hash drift, e.g. `markdown_bytes`, `doclingdocument_json`, `pandoc_ast_json`.","Deterministic formula: `conv_uid = sha256(conv_parsing_tool + \"\\n\" + conv_representation_type + \"\\n\" + conv_representation_bytes)` where `\"\\n\"` is a literal newline separator.","Block locators are tool-specific pointers back into the converted representation (offset ranges for Markdown; JSON pointers/refs for DoclingDocument; AST paths for Pandoc AST if used)."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"immutable_fields_doc_promoted_as_current_reference","entityType":"milestone","observations":["Promoted `docs/product-defining/immutable-fields.md` as the current vNext reference for the immutable envelope fields (role, definitions, data types, and deterministic hash rules).","Consolidated the previously-discussed immutable field table into `docs/product-defining/immutable-fields.md` in clean Markdown (removing HTML-entity artifacts and legacy drift).","Readers should use this doc as the canonical source for vNext field names and meanings while other docs are still being reconciled."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"core_features_and_purpose_intro_refreshed_to_match_vnext","entityType":"milestone","observations":["Updated the first portion of `core features and purpose.md` to align with confirmed design: two-track ingestion, vNext immutable naming, and block-type inventories for DoclingDocument vs mdast.","Inserted a hard stop marker (`======stopâ€”----------`) to clearly separate the refreshed intro from downstream illustrative sections, so future edits do not accidentally drift or overwrite the rest of the document.","Primary docs to read for the current direction: `core features and purpose.md` (intro), `docs/product-defining/immutable-fields.md` (vNext immutable), and the block type tables embedded in `core features and purpose.md`."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"canon_docs_product_defining_v2_0_established","entityType":"decision","observations":["Canon product-defining PRD/spec docs are managed under docs/product-defining-v2.0/.","Current canon set: docs/product-defining-v2.0/0207-prd-doc1.md, docs/product-defining-v2.0/0207-prd-tech-spec-doc2.md, docs/product-defining-v2.0/0207-blocks.md, docs/product-defining-v2.0/0207-immutable-fields.md, docs/product-defining-v2.0/0207-defining-user-defined-schemas.md.","The dated 0207-* filenames represent the current canon snapshot; when stable, the repo may also maintain non-dated aliases (blocks.md, immutable-fields.md, Defining User-Defined Schemas.md, 2. prd-technical-spec-v3.0-draft.md) to prevent broken cross-references.","Earlier references that treat core features and purpose.md or docs/product-defining/immutable-fields.md as the primary canon are now considered legacy; the canon source of truth is the docs/product-defining-v2.0/ set above."],"timestamp":"2026-02-07T01:10:00Z"}
{"name":"repo_changelog_and_rules_files_added","entityType":"decision","observations":["Added repo-changelog.jsonl and repo-rules.jsonl to separate (A) repository decisions/milestones from (B) process/rules the assistant must follow.","Policy: changelog.jsonl remains an append-only audit trail; it is not rewritten to remove legacy decisions unless explicitly approved. New entries supersede old ones by referencing them and pointing to updated canon docs.","repo-changelog.jsonl may be used as a curated current-direction subset if desired, but omissions there must never be interpreted as deletions from changelog.jsonl."],"timestamp":"2026-02-07T01:10:00Z"}
{"timestamp":"2026-02-10T05:37:12Z","observations":["Implemented the projects hierarchy in Postgres: created `public.projects` with full owner-scoped RLS policies, added `documents_v2.project_id` with FK to projects, and backfilled legacy documents into a per-owner `Default Project` (migration 008).","Implemented project-scoped navigation in the web app: `/app` lists projects; `/app/projects/:projectId` is the project container; upload, document detail, and run detail routes are all scoped under the project path.","Hardened project association at ingest time: `supabase/functions/ingest` accepts `project_id` and validates ownership server-side because the function uses service-role credentials (RLS bypass).","Updated the app nav to the storyboard model (Projects, Schemas, Integrations) and fixed active-state highlighting for `/app/projects/*` routes."],"name":"projects_hierarchy_implemented","entityType":"milestone"}
{"timestamp":"2026-02-10T05:37:12Z","observations":["Published the visual UX target for the web frontend in `docs/frontend/0208-visual-storyboard.md` (project-centric model, simplified nav, wizard flow, and the Block Grid as the primary working surface).","Published the authoritative theme specification in `docs/frontend/design-tokens.md` (Mantine v8 shadcn-style tokens + AG Grid alignment via CSS variables)."],"name":"frontend_storyboard_and_design_tokens_published","entityType":"milestone"}
{"timestamp":"2026-02-10T05:37:12Z","observations":["Consolidated next development steps into `docs/platform/0209-unified-remaining-work.md`, including a critical path and a phase-by-phase checklist from current state to production-ready platform.","Captured a succinct platform snapshot in `docs/platform/status-report.md` to make Tier 1 (pipeline unblockers) vs Tier 2 (frontend redesign) priorities explicit.","Documented the proposed review contract for overlays (staging vs confirmed) in `docs/platform/complete/0209-staging-vs-confirmed-overlays.md` as the foundation for safe exports/integrations."],"name":"platform_next_steps_consolidated","entityType":"milestone"}
{"timestamp":"2026-02-10T05:37:12Z","observations":["Reorganized the docs tree to separate frontend UX specs from platform execution planning: moved prior `docs/web-frontend/*` materials into `docs/frontend/*` and `docs/platform/*` with `complete/` and `remaining/` subfolders.","Policy intent: `docs/frontend/` is the UI/UX specification surface; `docs/platform/` is the cross-cutting platform plan and status surface; neither should be treated as long-term product vision (that remains in `docs/product-defining-v2.0/`)."],"name":"docs_frontend_platform_reorganized","entityType":"decision"}
{"timestamp":"2026-02-10T05:37:12Z","observations":["Verified that the Cloud Run conversion service base URL is now publicly reachable and returns HTTP 401 (application auth gate) rather than HTTP 403 (GCP IAM/Invoker), meaning the previously-recorded org-policy invoker restriction is no longer blocking network access.","Clarified that this verification only proves reachability/auth-gate behavior; end-to-end non-Markdown ingest still depends on correct Supabase Edge Function secrets (`CONVERSION_SERVICE_URL`/`CONVERSION_SERVICE_KEY`) and the callback flow into `conversion-complete`."],"name":"cloud_run_conversion_service_reachability_verified","entityType":"milestone"}
{"timestamp":"2026-02-10T18:00:00Z","name":"docling_tree_traversal_bugfix","entityType":"bugfix","observations":["Root cause: deployed `_shared/docling.ts` in `conversion-complete` v7 did not recurse into `children` of text items. DoclingDocument uses a hierarchical tree where `body.children` references top-level titles/section_headers, and those nodes have `children` arrays referencing paragraphs, lists, tables, etc. Without recursion, only the top-level headings were emitted as blocks — all other content was silently dropped.","Fix: `resolveAndEmit()` now always recurses into `textItem.children`, `tableItem.children`, and `picItem.children` after emitting the parent block. A `visited` set (added in local code but not deployed) prevents infinite cycles. Groups already recursed correctly.","Strengthened from earlier local-only partial fix that guarded recursion behind `shouldRecurseIntoTextChildren()` (title/section_header only) — now unconditional since any DoclingDocument node type can have children.","Deployed as `conversion-complete` v8. Existing broken DOCX documents need deletion and re-upload to re-trigger the pipeline (idempotency check blocks re-processing of `status=ingested` documents).","PDF conversion failure identified as separate issue: Docling's Python pipeline requires HuggingFace Hub model downloads for PDF layout analysis; the Cloud Run conversion service environment failed to fetch them. Not a code bug — infrastructure/networking issue."]}
{"timestamp":"2026-02-10T18:00:00Z","name":"document_detail_layout_restructured","entityType":"decision","observations":["Lifted `useRuns` hook and `selectedRunId` state from `BlockViewerGrid` up to `DocumentDetail` to separate run selection from grid toolbar controls.","DocumentDetail now renders three visual rows: (1) doc header (title, status badge, metadata, Export/Delete), (2) run selector row (RunSelector dropdown, run status badge, progress bar), (3) grid toolbar (type filter, density toggle, column visibility on left; block count + page size on right).","BlockViewerGrid now accepts `selectedRunId` and `selectedRun` as props instead of managing its own run state. Removed `useRuns` import, `RunSelector` import, `runProgress` computation, and run-related JSX from the toolbar.","Fixed React hooks violation: `useRuns` was initially placed after `if (loading) return` early return, causing 'Rendered more hooks than during the previous render' crash. Moved hook call before all early returns."]}
{"timestamp":"2026-02-11T09:25:16Z","name":"multi_provider_settings_e2e_added","entityType":"milestone","observations":["Implemented end-to-end multi-provider settings support across web and edge APIs for `anthropic`, `openai`, `google`, and `custom` providers.","`web/src/pages/Settings.tsx` now manages provider-specific defaults and enforces `base_url` for custom endpoints.","`supabase/functions/test-api-key` now validates provider keys against provider-specific endpoints, including OpenAI `/v1/models`, Google `/v1beta/models`, and custom `/models`.","`supabase/functions/user-api-keys` now accepts and persists `base_url` for custom provider rows while preserving per-provider model defaults.","Worker execution remains Anthropic-only for now; multi-provider runtime dispatch is still pending in the core priority queue."]}
{"timestamp":"2026-02-11T12:11:46Z","name":"schema_advanced_editor_meta_configurator_embed_added","entityType":"milestone","observations":["Added a schema advanced-editor path in the web app backed by a MetaConfigurator embed bundle.","Added embed build plumbing (`scripts/build-meta-configurator-embed.mjs`) and checked in generated embed assets under `web/public/meta-configurator-embed`.","Added integration spec and status artifacts under `docs/ongoing-tasks/meta-configurator-integration/` and reorganized related ongoing-task docs for execution tracking."]}
{"timestamp":"2026-02-11T17:03:39Z","name":"shell_v2_scaffold_and_meta_configurator_fork_added","entityType":"milestone","observations":["Introduced shell v2 scaffolding in the web app, including updated app layout, left rail, top command bar, and workspace home surface.","Added a vendored `third_party/meta-configurator` fork to stabilize embed behavior and local reproducible builds.","Expanded execution planning docs for shell-v2 and assistant-direction sequencing under `docs/ongoing-tasks/`."]}
{"timestamp":"2026-02-11T19:20:43Z","name":"format_reliability_gate_passed_all_required_formats","entityType":"milestone","observations":["Added committed smoke fixtures for `pptx` and `xlsx` and ran the full format matrix via `scripts/run-format-matrix-smoke.ps1`.","Latest recorded matrix run (`20260211-124133`) passed all required formats: `md`, `txt`, `docx`, `pdf`, `pptx`, `xlsx`, `html`, `csv`.","Priority 1 (format reliability gate) is marked `Passed` in the core queue with linked per-format log artifacts."]}
{"timestamp":"2026-02-11T20:24:08Z","name":"worker_claim_release_reliability_fix_deployed_v6","entityType":"bugfix","observations":["Fixed worker claim-release reliability by adding a dedicated release helper that performs strict release (`run_id + claimed_by + block_uid`) and targeted fallback release (`run_id + block_uid`).","Deployed the worker fix as version `6` and verified no-key, cancelled-run, and invalid-key paths release claims back to `pending` without stranding overlays.","Priority 2 remains `In Progress`: happy-path success, retry-to-terminal-failed behavior, and rollup parity checks still require a valid configured provider key."]}
{"timestamp":"2026-02-11T20:24:08Z","name":"docs_site_canonical_specs_and_living_workstream_pages_updated","entityType":"milestone","observations":["Expanded docs-site with canonical pages for export contract, immutable fields, and overlay confirmation contract using near-verbatim source content from product-defining and platform docs.","Updated docs policy to prefer verbatim copy plus surgical edits for canonical content and to keep volatile plans in `docs/ongoing-tasks` unless explicitly labeled as living docs.","Added and expanded docs-site ongoing-work pages plus styling updates, including dark-mode theme refinements.","Operational note: keep docs-site ongoing-work gate status synchronized with `docs/ongoing-tasks` to avoid stale `6/8` matrix references after the full pass."]}
