{"name": "prd_drafted", "entityType": "milestone", "observations": ["Initial PRD written for Block Inventory + User-Defined Schemas + Annotation Pipeline", "Covers core concepts, canonical record format, field reference, ingestion pipeline, annotation pipeline, error states, frontend requirements"], "timestamp": "2026-02-02T21:44:00Z"}
{"name": "prd_inconsistencies_identified", "entityType": "decision", "observations": ["Immutability rule too narrow - excluded schema_ref from changeable fields", "Annotation pipeline output implied all blocks filled - contradicted error states", "Section numbering gap between 2.3 and 8.1", "Schema binding described from two vantage points without distinct step"], "timestamp": "2026-02-02T21:48:00Z"}
{"name": "immutable_schema_ownership_fixed", "entityType": "decision", "observations": ["Immutable schemas are system-provided not user-defined", "Section 2.3 header corrected from 'both user-defined' to 'different sources; different orientations'", "Ingestion pipeline input corrected to 'user selection from system-provided immutable schemas'", "Frontend 9.1 corrected to 'Select immutable schema from system-provided options'"], "timestamp": "2026-02-02T22:06:00Z"}
{"name": "universal_envelope_confirmed", "entityType": "architecture", "observations": ["Envelope shape is identical across all document types", "immutable_schema_ref is classification label only not shape modifier", "All document-type-specific richness lives in annotation layer via swappable annotation schemas", "No schema-specific immutable fields, no extended key"], "timestamp": "2026-02-02T22:55:00Z"}
{"name": "docling_selected_for_ingest", "entityType": "integration", "observations": ["Docling (IBM, MIT license) selected as document parser for non-MD formats", "Pipeline: any format -> Docling -> .md -> remark-parse -> AST -> blocks", "Docling is separate utility outside core pipeline, not embedded in spec", "Markdown is the universal entry point to the pipeline"], "timestamp": "2026-02-02T22:16:00Z"}
{"name": "remark_parse_selected", "entityType": "integration", "observations": ["remark-parse (unified/remark ecosystem) selected as MD parser", "AST nodes provide position.start.offset and position.end.offset for char_span", "Node types map directly to block_type", "Tree structure provides section_path via heading nesting", "doc_title auto-extracted from first H1 heading, fallback to filename"], "timestamp": "2026-02-02T23:00:00Z"}
{"name": "backend_postgres_supabase", "entityType": "architecture", "observations": ["Chose Supabase/PostgreSQL over PocketBase/SQLite", "Blocks stored as database rows not JSONL files", "Row-level locking enables true concurrent AI annotation", "JSONL is export format generated on demand from DB", "Supabase project block-annotation created in us-west-1 project id dbdzzhshmigewyprahej"], "timestamp": "2026-02-02T22:38:00Z"}
{"name": "concurrent_annotation_pattern", "entityType": "architecture", "observations": ["Workers claim blocks via atomic UPDATE WHERE status=pending RETURNING *", "Each worker writes annotation.data back to claimed row", "Failed blocks move to failed with error recorded or revert to pending based on retry policy", "Frontend subscribes to block status changes via Supabase Realtime"], "timestamp": "2026-02-02T22:34:00Z"}
{"name": "export_branches_defined", "entityType": "architecture", "observations": ["JSONL file export for document revision, archival, portability", "KG ingest - extract triples/entities/relations from annotation.data -> graph DB", "Document reconstruction - extract content across blocks -> assemble .md -> Pandoc -> docx/pdf/html", "Docling in, Pandoc out, .md as pivot format both directions"], "timestamp": "2026-02-02T23:10:00Z"}
{"name": "prd_use_cases_fixed", "entityType": "decision", "observations": ["SC/Law Cases subsection corrected - law_case_v1 is classification label, same universal envelope", "KB/KG subsection corrected - kb_chunk_v1 is classification label, same universal envelope", "Removed language implying immutable schema changes envelope shape per document type"], "timestamp": "2026-02-02T23:15:00Z"}
{"name": "repo_initialized", "entityType": "milestone", "observations": ["MD-ANNOTATE repo created", "README.md written with pipeline overview, key ideas, and stack", "MD = markdown + metadata dual meaning"], "timestamp": "2026-02-02T23:30:00Z"}
{"name": "three_hash_identity_model", "entityType": "architecture", "observations": ["source_uid = SHA256(source_type + newline + raw_source_bytes) - identity of uploaded blob", "md_uid = SHA256(raw_markdown_bytes) - identity of Markdown used for ingest", "doc_uid = SHA256(immutable_schema_ref + newline + md_uid) - identity of document under a schema", "block_uid = SHA256(doc_uid + colon + block_index) - unchanged formula uses new doc_uid", "For .md uploads all three hashes computable immediately", "For non-MD uploads md_uid and doc_uid computed after conversion completes", "md_uid enables dedup across formats - converted docx matching uploaded md yields same md_uid", "Same Markdown under different immutable_schema_ref produces different doc_uid"], "timestamp": "2026-02-02T23:50:00Z"}
{"name": "docling_integrated_into_pipeline", "entityType": "decision", "observations": ["Docling upgraded from separate external utility to integrated pipeline component", "Upload accepts md docx pdf pptx txt - system handles conversion internally", "Format variety is a feature not a complication - users should not convert files themselves", "Replaces PRD v2 language that said users run Docling separately before upload"], "timestamp": "2026-02-02T23:52:00Z"}
{"name": "single_documents_table", "entityType": "decision", "observations": ["One documents table with source_uid md_uid and doc_uid columns - not two tables", "For .md uploads all columns populated in single request", "For non-MD uploads md_uid and doc_uid start NULL populated after conversion callback", "Two-table split (sources + documents) rejected as unnecessary complexity for Phase 1", "Can split later if lifecycle separation becomes operationally messy"], "timestamp": "2026-02-02T23:54:00Z"}
{"name": "service_architecture_boundary", "entityType": "architecture", "observations": ["Edge Functions (Deno/TS) own all database operations", "Python microservice (FastAPI) touches Supabase Storage only never Postgres", "Python authenticates via shared secret env var", "Edge Functions generate signed Storage URLs so Python needs no Supabase keys", "Conversion flow commits documents row before calling Python service to prevent race condition", "Callback carries source_uid as reference - doc_uid may not exist yet for non-MD"], "timestamp": "2026-02-02T23:56:00Z"}
{"name": "timeout_failure_handling", "entityType": "architecture", "observations": ["Edge Function sets configurable request timeout when calling Python service", "On timeout Edge Function immediately sets status=conversion_failed with error message", "pg_cron scheduled job catches stale converting rows older than 5 minutes as safety net", "Covers edge case where Edge Function crashes after calling Python but before handling timeout", "Error column added to documents table - TEXT NULL for human-readable failure messages"], "timestamp": "2026-02-02T23:58:00Z"}
{"name": "auth_rls_model", "entityType": "architecture", "observations": ["Writes via Edge Functions only using service role key", "Reads via authenticated user JWT with RLS policies checking owner_id", "Anon key not used for production reads - user authentication required", "No client-side inserts or updates ever - all mutations through Edge Functions", "Python microservice authenticates to Edge Function callbacks via shared secret"], "timestamp": "2026-02-03T00:00:00Z"}
{"name": "ddl_hardening_decisions", "entityType": "decision", "observations": ["source_uid md_uid doc_uid block_uid CHECK constraint matches 64-char hex pattern", "char_span elements nonnegative and start <= end", "block_index >= 0 constraint", "source_type CHECK IN md docx pdf pptx txt", "status CHECK IN uploaded converting ingested conversion_failed ingest_failed", "ON DELETE CASCADE on blocks -> documents", "Indexes on blocks(doc_uid) blocks(doc_uid block_index) documents(uploaded_at DESC)"], "timestamp": "2026-02-03T00:02:00Z"}
{"name": "prd_v3_produced", "entityType": "milestone", "observations": ["PRD updated from v2 to v3 incorporating all architecture decisions since backend section added", "Three-hash identity model with Identity Model section and Identity Behavior by Upload Type", "Docling integrated into pipeline with full conversion flow spec", "Timeout and failure handling with pg_cron stale cleanup", "Documents table redesigned with source_uid md_uid doc_uid status error md_locator", "Auth and RLS section added", "DDL hardening with CHECK constraints and indexes", "PK question flagged for DDL spec - doc_uid as PK vs source_uid as PK with doc_uid UNIQUE FK target"], "timestamp": "2026-02-03T00:05:00Z"}
{"name": "ddl_migration_001_deployed", "entityType": "milestone", "observations": ["Migration 001_phase1_immutable_documents_blocks applied to Supabase", "documents + blocks tables live with 13 CHECK constraints and 9 indexes", "RLS policies: documents_select_own, blocks_select_own (SELECT only, no client writes)", "Trigger set_documents_updated_at applied", "One advisory: set_updated_at function needs SET search_path = '' (minor security fix)"], "timestamp": "2026-02-03T00:10:00Z"}
{"name": "prd_v4_produced", "entityType": "milestone", "observations": ["PRD updated to v4 reflecting deployed DDL and Edge Function architecture", "Platform roadmap section drafted as companion document mapping capabilities to architectural primitives"], "timestamp": "2026-02-03T00:15:00Z"}
{"name": "edge_functions_phase1_deployed", "entityType": "milestone", "observations": ["Three Edge Functions live on Supabase project dbdzzhshmigewyprahej", "ingest (POST, JWT): .md path does full ingest in one request, non-md path fires async conversion", "conversion-complete (POST, API key auth): callback from Python service, idempotent with job_id guard", "export-jsonl (GET, JWT): RLS-enforced export with immutable envelope + empty annotation stub", "Shared modules: cors.ts, env.ts, hash.ts, markdown.ts, sanitize.ts, supabase.ts", "remark-parse integrated in markdown.ts for AST-based block extraction"], "timestamp": "2026-02-03T00:20:00Z"}
{"name": "platform_roadmap_defined", "entityType": "architecture", "observations": ["Three-tier product vision: Tool (Phase 1-2) -> Platform (Tier 2) -> Infrastructure (Tier 3)", "Phase 1: Upload -> blocks -> JSONL export (immutable inventory only)", "Phase 2: Multi-schema annotation via schemas + annotation_runs + block_annotations", "Tier 2: Visual schema builder, schema gallery, schema versioning - all additive to schemas table", "Tier 3: Export connectors, model adapters, event system, REST API", "Every capability grounded to specific tables/columns/patterns that already exist"], "timestamp": "2026-02-03T00:25:00Z"}
{"name": "learning_commons_inspiration", "entityType": "architecture", "observations": ["Learning Commons (CZI/Anthropic) identified as architectural inspiration", "Pattern: domain corpus -> structured entities -> relationship edges -> AI pipeline infrastructure", "LC atomic unit = learning component (standards-aligned skill), MD-ANNOTATE atomic unit = block (content-addressed paragraph)", "Both share: stable identity, structured extraction, schema-driven annotation, multi-destination export", "LC built for education domain; MD-ANNOTATE generalizes pattern to any document domain"], "timestamp": "2026-02-03T00:30:00Z"}
{"name": "granularity_flexibility_confirmed", "entityType": "architecture", "observations": ["Block as atomic unit is configurable at split time not hardcoded", "Splitter config driven by immutable_schema_ref classification label", "Examples: md_prose_v1 (paragraph), md_chapter_v1 (H1-level), legal_opinion_v1 (section-level)", "Higher-level units are views over blocks via section_path or block_index ranges", "Same envelope, same annotation overlay, same export branches - only splitting rule changes"], "timestamp": "2026-02-03T00:35:00Z"}
{"name": "edge_functions_gateway_jwt_verification_disabled_dev", "entityType": "decision", "observations": ["Redeployed Edge Functions `ingest` and `export-jsonl` with verify_jwt=false at the gateway layer to avoid gateway-level JWT rejection during development", "Authorization is still required and validated inside functions via Supabase Auth (`auth.getUser()`), which remains load-bearing for documents.owner_id", "Production plan: re-enable gateway JWT verification or implement explicit JWT verification against Supabase signing keys (JWKS) inside functions"], "timestamp": "2026-02-02T11:55:58Z"}
{"name": "smoke_test_md_ingest_export_passed", "entityType": "milestone", "observations": ["Smoke test succeeded end-to-end for .md ingest and JSONL export", "Ingested `json-schemas/prd-v4.md` and produced 216 blocks", "Export produced JSONL matching PRD contract shape with inert annotation placeholder (schema_ref null; data {})"], "timestamp": "2026-02-02T11:55:58Z"}
{"name": "smoke_test_script_secret_hygiene_hardened", "entityType": "decision", "observations": ["Updated `scripts/smoke-test.ps1` to avoid hardcoding credentials: prompts for email/password or uses TEST_EMAIL/TEST_PASSWORD env vars", "Added early validation for SUPABASE_URL/SUPABASE_ANON_KEY and added JWT diagnostics (Auth verification + Functions probe) to reduce debugging time"], "timestamp": "2026-02-02T11:55:58Z"}
{"name":"phase2_tables_deployed","entityType":"milestone","observations":["Applied Phase 2 DDL migration: `schemas`, `annotation_runs`, `block_annotations`","Added RPC `create_annotation_run(owner_id, doc_uid, schema_id)` to create a run and populate per-block rows atomically","Enabled RLS read policies for Phase 2 tables (SELECT only; writes via Edge Functions)"],"timestamp":"2026-02-02T12:10:00Z"}
{"name":"phase2_edge_functions_deployed","entityType":"milestone","observations":["Deployed Edge Function `schemas` (POST /schemas) for end-user schema upload","Deployed Edge Function `runs` (POST /runs) to create `annotation_runs` + populate `block_annotations` via RPC","Extended `export-jsonl` to support `run_id` (overlays per-block annotation data) in addition to `doc_uid` (Phase 1 placeholder)"],"timestamp":"2026-02-02T12:12:00Z"}
{"name":"repo_migrations_added","entityType":"milestone","observations":["Added `supabase/migrations/` to repo and reconstructed Phase 1 migration file from live DB state","Added Phase 2 migration file to repo to keep DDL under version control going forward","Added `json-schemas/ddl-plan.md` as a stable pointer to `json-schemas/complete/ddl-plan.md`"],"timestamp":"2026-02-02T12:14:00Z"}
{"name":"phase2_smoke_test_added","entityType":"milestone","observations":["Added Phase 2 scaffolding smoke test `scripts/smoke-test-schema-run.ps1` (ingest .md -> upload schema -> create run -> export JSONL by run_id)","Phase 2 export includes `annotation.schema_ref`, `annotation.schema_uid`, and per-block `annotation.data` (empty `{}` until a worker writes results)"],"timestamp":"2026-02-02T12:16:00Z"}
{"name":"phase2_smoke_test_run_create_body_fix","entityType":"decision","observations":["Adjusted `scripts/smoke-test-schema-run.ps1` to send the run-create JSON body via a temp file (`--data-binary @file`) to avoid PowerShell argument/encoding edge cases","Uses ASCII encoding for the temp file to avoid UTF-8 BOM JSON parse failures"],"timestamp":"2026-02-02T12:18:00Z"}
{"name":"ingest_idempotency_storage_upsert","entityType":"decision","observations":["Fixed Phase 1 ingest idempotency: repeated ingest of the same file no longer fails with Storage 'resource already exists'","`ingest` now short-circuits if `documents.source_uid` already exists and returns the existing status/doc_uid","Storage upload switched to `upsert: true` (safe because the object key is content-addressed by `source_uid`)"],"timestamp":"2026-02-02T12:30:00Z"}
{"name":"schema_upload_idempotent_by_ref","entityType":"decision","observations":["Made `POST /schemas` idempotent for repeated uploads","If `(owner_id, schema_ref)` already exists and `schema_uid` matches, the function returns the existing schema row (200) instead of erroring","If `schema_ref` exists but `schema_uid` differs, the function returns 409 conflict so schema versions are explicit"],"timestamp":"2026-02-02T12:34:00Z"}
{"name":"user_defined_schema_repo_location","entityType":"decision","observations":["Standardized on `json-schemas/user-defined/` as the repo location for example user-defined schemas","Updated `scripts/smoke-test-schema-run.ps1` to default to that folder (or `$env:SCHEMA_FILE`) when uploading a schema"],"timestamp":"2026-02-02T12:40:00Z"}
{"name":"schema_run_export_proof_saved","entityType":"milestone","observations":["Ran ingest + schema upload + run creation + export on `docs/test-pack/a2-v4.8-10787.docx.md` (347 blocks)","Saved canonical per-block JSON proof artifacts for selected blocks (5, 25, 100, 150, 250) under `docs/test-pack/` to validate export shape and frontend binding"],"timestamp":"2026-02-02T12:55:00Z"}
{"name":"smoke_test_runs_body_file_arg_fix","entityType":"decision","observations":["Fixed `scripts/smoke-test-schema-run.ps1` to pass JSON request body to curl using the `@file` syntax without quotes (`--data-binary @file`) so the `/runs` function receives valid JSON in PowerShell"],"timestamp":"2026-02-02T12:56:00Z"}
