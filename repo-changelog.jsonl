{"name":"repo_changelog_scope","entityType":"decision","observations":["repo-changelog.jsonl is intended to be the current-direction changelog for the repo.","It may omit older entries for brevity, but the authoritative append-only audit trail is changelog.jsonl.","Omissions in repo-changelog.jsonl are not deletions; they are an intentional curated view."],"timestamp":"2026-02-07T01:10:00Z"}
{"name": "prd_drafted", "entityType": "milestone", "observations": ["Initial PRD written for Block Inventory + User-Defined Schemas + Annotation Pipeline", "Covers core concepts, canonical record format, field reference, ingestion pipeline, annotation pipeline, error states, frontend requirements"], "timestamp": "2026-02-02T21:44:00Z"}
{"name": "prd_inconsistencies_identified", "entityType": "decision", "observations": ["Immutability rule too narrow - excluded schema_ref from changeable fields", "Annotation pipeline output implied all blocks filled - contradicted error states", "Section numbering gap between 2.3 and 8.1", "Schema binding described from two vantage points without distinct step"], "timestamp": "2026-02-02T21:48:00Z"}
{"name": "immutable_schema_ownership_fixed", "entityType": "decision", "observations": ["Immutable schemas are system-provided not user-defined", "Section 2.3 header corrected from 'both user-defined' to 'different sources; different orientations'", "Ingestion pipeline input corrected to 'user selection from system-provided immutable schemas'", "Frontend 9.1 corrected to 'Select immutable schema from system-provided options'"], "timestamp": "2026-02-02T22:06:00Z"}
{"name": "universal_envelope_confirmed", "entityType": "architecture", "observations": ["Envelope shape is identical across all document types", "immutable_schema_ref is classification label only not shape modifier", "All document-type-specific richness lives in annotation layer via swappable annotation schemas", "No schema-specific immutable fields, no extended key"], "timestamp": "2026-02-02T22:55:00Z"}
{"name": "docling_selected_for_ingest", "entityType": "integration", "observations": ["Docling (IBM, MIT license) selected as document parser for non-MD formats", "Pipeline: any format -> Docling -> .md -> remark-parse -> AST -> blocks", "Docling is separate utility outside core pipeline, not embedded in spec", "Markdown is the universal entry point to the pipeline"], "timestamp": "2026-02-02T22:16:00Z"}
{"name": "remark_parse_selected", "entityType": "integration", "observations": ["remark-parse (unified/remark ecosystem) selected as MD parser", "AST nodes provide position.start.offset and position.end.offset for char_span", "Node types map directly to block_type", "Tree structure provides section_path via heading nesting", "doc_title auto-extracted from first H1 heading, fallback to filename"], "timestamp": "2026-02-02T23:00:00Z"}
{"name": "backend_postgres_supabase", "entityType": "architecture", "observations": ["Chose Supabase/PostgreSQL over PocketBase/SQLite", "Blocks stored as database rows not JSONL files", "Row-level locking enables true concurrent AI annotation", "JSONL is export format generated on demand from DB", "Supabase project block-annotation created in us-west-1 project id dbdzzhshmigewyprahej"], "timestamp": "2026-02-02T22:38:00Z"}
{"name": "concurrent_annotation_pattern", "entityType": "architecture", "observations": ["Workers claim blocks via atomic UPDATE WHERE status=pending RETURNING *", "Each worker writes annotation.data back to claimed row", "Failed blocks move to failed with error recorded or revert to pending based on retry policy", "Frontend subscribes to block status changes via Supabase Realtime"], "timestamp": "2026-02-02T22:34:00Z"}
{"name": "export_branches_defined", "entityType": "architecture", "observations": ["JSONL file export for document revision, archival, portability", "KG ingest - extract triples/entities/relations from annotation.data -> graph DB", "Document reconstruction - extract content across blocks -> assemble .md -> Pandoc -> docx/pdf/html", "Docling in, Pandoc out, .md as pivot format both directions"], "timestamp": "2026-02-02T23:10:00Z"}
{"name": "prd_use_cases_fixed", "entityType": "decision", "observations": ["SC/Law Cases subsection corrected - law_case_v1 is classification label, same universal envelope", "KB/KG subsection corrected - kb_chunk_v1 is classification label, same universal envelope", "Removed language implying immutable schema changes envelope shape per document type"], "timestamp": "2026-02-02T23:15:00Z"}
{"name": "repo_initialized", "entityType": "milestone", "observations": ["MD-ANNOTATE repo created", "README.md written with pipeline overview, key ideas, and stack", "MD = markdown + metadata dual meaning"], "timestamp": "2026-02-02T23:30:00Z"}
{"name": "three_hash_identity_model", "entityType": "architecture", "observations": ["source_uid = SHA256(source_type + newline + raw_source_bytes) - identity of uploaded blob", "md_uid = SHA256(raw_markdown_bytes) - identity of Markdown used for ingest", "doc_uid = SHA256(immutable_schema_ref + newline + md_uid) - identity of document under a schema", "block_uid = SHA256(doc_uid + colon + block_index) - unchanged formula uses new doc_uid", "For .md uploads all three hashes computable immediately", "For non-MD uploads md_uid and doc_uid computed after conversion completes", "md_uid enables dedup across formats - converted docx matching uploaded md yields same md_uid", "Same Markdown under different immutable_schema_ref produces different doc_uid"], "timestamp": "2026-02-02T23:50:00Z"}
{"name": "docling_integrated_into_pipeline", "entityType": "decision", "observations": ["Docling upgraded from separate external utility to integrated pipeline component", "Upload accepts md docx pdf pptx txt - system handles conversion internally", "Format variety is a feature not a complication - users should not convert files themselves", "Replaces PRD v2 language that said users run Docling separately before upload"], "timestamp": "2026-02-02T23:52:00Z"}
{"name": "single_documents_table", "entityType": "decision", "observations": ["One documents table with source_uid md_uid and doc_uid columns - not two tables", "For .md uploads all columns populated in single request", "For non-MD uploads md_uid and doc_uid start NULL populated after conversion callback", "Two-table split (sources + documents) rejected as unnecessary complexity for Phase 1", "Can split later if lifecycle separation becomes operationally messy"], "timestamp": "2026-02-02T23:54:00Z"}
{"name": "service_architecture_boundary", "entityType": "architecture", "observations": ["Edge Functions (Deno/TS) own all database operations", "Python microservice (FastAPI) touches Supabase Storage only never Postgres", "Python authenticates via shared secret env var", "Edge Functions generate signed Storage URLs so Python needs no Supabase keys", "Conversion flow commits documents row before calling Python service to prevent race condition", "Callback carries source_uid as reference - doc_uid may not exist yet for non-MD"], "timestamp": "2026-02-02T23:56:00Z"}
{"name": "timeout_failure_handling", "entityType": "architecture", "observations": ["Edge Function sets configurable request timeout when calling Python service", "On timeout Edge Function immediately sets status=conversion_failed with error message", "pg_cron scheduled job catches stale converting rows older than 5 minutes as safety net", "Covers edge case where Edge Function crashes after calling Python but before handling timeout", "Error column added to documents table - TEXT NULL for human-readable failure messages"], "timestamp": "2026-02-02T23:58:00Z"}
{"name": "auth_rls_model", "entityType": "architecture", "observations": ["Writes via Edge Functions only using service role key", "Reads via authenticated user JWT with RLS policies checking owner_id", "Anon key not used for production reads - user authentication required", "No client-side inserts or updates ever - all mutations through Edge Functions", "Python microservice authenticates to Edge Function callbacks via shared secret"], "timestamp": "2026-02-03T00:00:00Z"}
{"name": "ddl_hardening_decisions", "entityType": "decision", "observations": ["source_uid md_uid doc_uid block_uid CHECK constraint matches 64-char hex pattern", "char_span elements nonnegative and start <= end", "block_index >= 0 constraint", "source_type CHECK IN md docx pdf pptx txt", "status CHECK IN uploaded converting ingested conversion_failed ingest_failed", "ON DELETE CASCADE on blocks -> documents", "Indexes on blocks(doc_uid) blocks(doc_uid block_index) documents(uploaded_at DESC)"], "timestamp": "2026-02-03T00:02:00Z"}
{"name": "prd_v3_produced", "entityType": "milestone", "observations": ["PRD updated from v2 to v3 incorporating all architecture decisions since backend section added", "Three-hash identity model with Identity Model section and Identity Behavior by Upload Type", "Docling integrated into pipeline with full conversion flow spec", "Timeout and failure handling with pg_cron stale cleanup", "Documents table redesigned with source_uid md_uid doc_uid status error md_locator", "Auth and RLS section added", "DDL hardening with CHECK constraints and indexes", "PK question flagged for DDL spec - doc_uid as PK vs source_uid as PK with doc_uid UNIQUE FK target"], "timestamp": "2026-02-03T00:05:00Z"}
{"name": "ddl_migration_001_deployed", "entityType": "milestone", "observations": ["Migration 001_phase1_immutable_documents_blocks applied to Supabase", "documents + blocks tables live with 13 CHECK constraints and 9 indexes", "RLS policies: documents_select_own, blocks_select_own (SELECT only, no client writes)", "Trigger set_documents_updated_at applied", "One advisory: set_updated_at function needs SET search_path = '' (minor security fix)"], "timestamp": "2026-02-03T00:10:00Z"}
{"name": "prd_v4_produced", "entityType": "milestone", "observations": ["PRD updated to v4 reflecting deployed DDL and Edge Function architecture", "Platform roadmap section drafted as companion document mapping capabilities to architectural primitives"], "timestamp": "2026-02-03T00:15:00Z"}
{"name": "edge_functions_phase1_deployed", "entityType": "milestone", "observations": ["Three Edge Functions live on Supabase project dbdzzhshmigewyprahej", "ingest (POST, JWT): .md path does full ingest in one request, non-md path fires async conversion", "conversion-complete (POST, API key auth): callback from Python service, idempotent with job_id guard", "export-jsonl (GET, JWT): RLS-enforced export with immutable envelope + empty annotation stub", "Shared modules: cors.ts, env.ts, hash.ts, markdown.ts, sanitize.ts, supabase.ts", "remark-parse integrated in markdown.ts for AST-based block extraction"], "timestamp": "2026-02-03T00:20:00Z"}
{"name": "platform_roadmap_defined", "entityType": "architecture", "observations": ["Three-tier product vision: Tool (Phase 1-2) -> Platform (Tier 2) -> Infrastructure (Tier 3)", "Phase 1: Upload -> blocks -> JSONL export (immutable inventory only)", "Phase 2: Multi-schema annotation via schemas + annotation_runs + block_annotations", "Tier 2: Visual schema builder, schema gallery, schema versioning - all additive to schemas table", "Tier 3: Export connectors, model adapters, event system, REST API", "Every capability grounded to specific tables/columns/patterns that already exist"], "timestamp": "2026-02-03T00:25:00Z"}
{"name": "learning_commons_inspiration", "entityType": "architecture", "observations": ["Learning Commons (CZI/Anthropic) identified as architectural inspiration", "Pattern: domain corpus -> structured entities -> relationship edges -> AI pipeline infrastructure", "LC atomic unit = learning component (standards-aligned skill), MD-ANNOTATE atomic unit = block (content-addressed paragraph)", "Both share: stable identity, structured extraction, schema-driven annotation, multi-destination export", "LC built for education domain; MD-ANNOTATE generalizes pattern to any document domain"], "timestamp": "2026-02-03T00:30:00Z"}
{"name": "granularity_flexibility_confirmed", "entityType": "architecture", "observations": ["Block as atomic unit is configurable at split time not hardcoded", "Splitter config driven by immutable_schema_ref classification label", "Examples: md_prose_v1 (paragraph), md_chapter_v1 (H1-level), legal_opinion_v1 (section-level)", "Higher-level units are views over blocks via section_path or block_index ranges", "Same envelope, same annotation overlay, same export branches - only splitting rule changes"], "timestamp": "2026-02-03T00:35:00Z"}
{"name": "edge_functions_gateway_jwt_verification_disabled_dev", "entityType": "decision", "observations": ["Redeployed Edge Functions `ingest` and `export-jsonl` with verify_jwt=false at the gateway layer to avoid gateway-level JWT rejection during development", "Authorization is still required and validated inside functions via Supabase Auth (`auth.getUser()`), which remains load-bearing for documents.owner_id", "Production plan: re-enable gateway JWT verification or implement explicit JWT verification against Supabase signing keys (JWKS) inside functions"], "timestamp": "2026-02-02T11:55:58Z"}
{"name": "smoke_test_md_ingest_export_passed", "entityType": "milestone", "observations": ["Smoke test succeeded end-to-end for .md ingest and JSONL export", "Ingested `json-schemas/prd-v4.md` and produced 216 blocks", "Export produced JSONL matching PRD contract shape with inert annotation placeholder (schema_ref null; data {})"], "timestamp": "2026-02-02T11:55:58Z"}
{"name": "smoke_test_script_secret_hygiene_hardened", "entityType": "decision", "observations": ["Updated `scripts/smoke-test.ps1` to avoid hardcoding credentials: prompts for email/password or uses TEST_EMAIL/TEST_PASSWORD env vars", "Added early validation for SUPABASE_URL/SUPABASE_ANON_KEY and added JWT diagnostics (Auth verification + Functions probe) to reduce debugging time"], "timestamp": "2026-02-02T11:55:58Z"}
{"name":"phase2_tables_deployed","entityType":"milestone","observations":["Applied Phase 2 DDL migration: `schemas`, `annotation_runs`, `block_annotations`","Added RPC `create_annotation_run(owner_id, doc_uid, schema_id)` to create a run and populate per-block rows atomically","Enabled RLS read policies for Phase 2 tables (SELECT only; writes via Edge Functions)"],"timestamp":"2026-02-02T12:10:00Z"}
{"name":"phase2_edge_functions_deployed","entityType":"milestone","observations":["Deployed Edge Function `schemas` (POST /schemas) for end-user schema upload","Deployed Edge Function `runs` (POST /runs) to create `annotation_runs` + populate `block_annotations` via RPC","Extended `export-jsonl` to support `run_id` (overlays per-block annotation data) in addition to `doc_uid` (Phase 1 placeholder)"],"timestamp":"2026-02-02T12:12:00Z"}
{"name":"repo_migrations_added","entityType":"milestone","observations":["Added `supabase/migrations/` to repo and reconstructed Phase 1 migration file from live DB state","Added Phase 2 migration file to repo to keep DDL under version control going forward","Added `json-schemas/ddl-plan.md` as a stable pointer to `json-schemas/complete/ddl-plan.md`"],"timestamp":"2026-02-02T12:14:00Z"}
{"name":"phase2_smoke_test_added","entityType":"milestone","observations":["Added Phase 2 scaffolding smoke test `scripts/smoke-test-schema-run.ps1` (ingest .md -> upload schema -> create run -> export JSONL by run_id)","Phase 2 export includes `annotation.schema_ref`, `annotation.schema_uid`, and per-block `annotation.data` (empty `{}` until a worker writes results)"],"timestamp":"2026-02-02T12:16:00Z"}
{"name":"phase2_smoke_test_run_create_body_fix","entityType":"decision","observations":["Adjusted `scripts/smoke-test-schema-run.ps1` to send the run-create JSON body via a temp file (`--data-binary @file`) to avoid PowerShell argument/encoding edge cases","Uses ASCII encoding for the temp file to avoid UTF-8 BOM JSON parse failures"],"timestamp":"2026-02-02T12:18:00Z"}
{"name":"ingest_idempotency_storage_upsert","entityType":"decision","observations":["Fixed Phase 1 ingest idempotency: repeated ingest of the same file no longer fails with Storage 'resource already exists'","`ingest` now short-circuits if `documents.source_uid` already exists and returns the existing status/doc_uid","Storage upload switched to `upsert: true` (safe because the object key is content-addressed by `source_uid`)"],"timestamp":"2026-02-02T12:30:00Z"}
{"name":"schema_upload_idempotent_by_ref","entityType":"decision","observations":["Made `POST /schemas` idempotent for repeated uploads","If `(owner_id, schema_ref)` already exists and `schema_uid` matches, the function returns the existing schema row (200) instead of erroring","If `schema_ref` exists but `schema_uid` differs, the function returns 409 conflict so schema versions are explicit"],"timestamp":"2026-02-02T12:34:00Z"}
{"name":"user_defined_schema_repo_location","entityType":"decision","observations":["Standardized on `json-schemas/user-defined/` as the repo location for example user-defined schemas","Updated `scripts/smoke-test-schema-run.ps1` to default to that folder (or `$env:SCHEMA_FILE`) when uploading a schema"],"timestamp":"2026-02-02T12:40:00Z"}
{"name":"schema_run_export_proof_saved","entityType":"milestone","observations":["Ran ingest + schema upload + run creation + export on `docs/test-pack/a2-v4.8-10787.docx.md` (347 blocks)","Saved canonical per-block JSON proof artifacts for selected blocks (5, 25, 100, 150, 250) under `docs/test-pack/` to validate export shape and frontend binding"],"timestamp":"2026-02-02T12:55:00Z"}
{"name":"smoke_test_runs_body_file_arg_fix","entityType":"decision","observations":["Fixed `scripts/smoke-test-schema-run.ps1` to pass JSON request body to curl using the `@file` syntax without quotes (`--data-binary @file`) so the `/runs` function receives valid JSON in PowerShell"],"timestamp":"2026-02-02T12:56:00Z"}
{"name":"ui_mockup_v2_overlays_column","entityType":"decision","observations":["Added a stronger UI mockup that matches the backend lifecycle: `ui/sample/blockdata-sample-mockup-v2.jsx`","Reframed the right column as overlays (runs) so it stays accurate before and after model integration (prepared vs processing vs complete)"],"timestamp":"2026-02-02T13:05:00Z"}
{"name":"ui_mockup_v3_dev_mode_runs","entityType":"decision","observations":["Added a dev-mode UI mockup that intentionally cues the model-connected direction while staying explicit that this environment is private: `ui/sample/blockdata-sample-mockup-v3.jsx`","Shows runs progressing (processing/complete) and calls out a worker loop concept (claim -> model -> complete) alongside always-available JSONL export"],"timestamp":"2026-02-02T13:10:00Z"}
{"name":"ui_nextjs_scaffold_added","entityType":"milestone","observations":["Scaffolded a real Next.js 14 App Router UI under `ui/` (TypeScript + Tailwind + shadcn-style primitives)","Pages: `/` (sign-in + upload/ingest + recent docs), `/documents/[source_uid]` (status + blocks + create run), `/schemas` (upload/list schemas), `/runs/[run_id]` (run detail + export overlay)","UI uses Supabase Auth + RLS reads and calls Edge Functions for ingest/schemas/runs/export"],"timestamp":"2026-02-02T13:25:00Z"}
{"name":"remark_mdast_retained_edge_runtime_reason","entityType":"decision","observations":["Keep Markdown->mdast parsing via remark inside Supabase Edge Functions (Deno) to avoid re-architecting parsing into a separate service.","mdast offsets (position.start/end.offset) are load-bearing for blocks.char_span, which supports future UX needs like highlighting/verification against the stored Markdown."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"pandoc_ast_parallel_pipeline_deferred","entityType":"decision","observations":["Do not replace remark/mdast with Pandoc AST in the core pipeline today (Pandoc cannot run in Edge Functions; Pandoc JSON AST does not provide equivalent source offsets for char_span).","Pandoc-based parsing may be added later as a separate parallel pipeline/service if needed for broader format coverage or richer structure."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"original_source_visibility_requirement_recorded","entityType":"decision","observations":["Treat source_locator (original upload bytes) as a first-class artifact for future schemas/workflows that require checking annotations against the original source.","Preserve md_locator + char_span so UI can reliably show block slices from the canonical Markdown used for ingest."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"conversion_callback_url_needs_functions_v1_path","entityType":"decision","observations":["Non-md end-to-end requires conversion service callbacks to hit the deployed Edge Function endpoint at /functions/v1/conversion-complete (not just /conversion-complete on the project origin).","Action: update ingest callback_url construction and keep the callback contract explicit in PRD/docs."],"timestamp":"2026-02-02T00:00:00Z"}
{"name":"frontend_stack_switched_to_sveltekit","entityType":"decision","observations":["Switched the frontend strategy from Next.js to a single SvelteKit app to improve solo-dev velocity and AI-assisted iteration.","Product shape remains the same: public marketing pages + auth-gated dashboard (/app/*).","Backend contract remains canonical: PostgREST reads under RLS; Edge Functions for ingest/schemas/runs/export."],"timestamp":"2026-02-03T09:00:00Z"}
{"name":"frontend_sveltekit_app_added","entityType":"milestone","observations":["Added the new primary frontend under `frontend/` (SvelteKit).","Implemented auth pages (/login, /logout) and protected dashboard routes under `/app/*`.","Implemented core dashboard flow pages: upload -> status -> blocks -> export, plus Phase 2 scaffolding pages for schemas and runs.","Added docs: ADR (`docs/refs/frontend-stack-decision.md`), migration guide, runbook, and routes/flows mapping under `docs/dev-plan/frontend/`."],"timestamp":"2026-02-03T09:30:00Z"}
{"name":"nextjs_ui_removed","entityType":"milestone","observations":["Removed the legacy Next.js UI directory (`ui/`) after the SvelteKit frontend was working.","Standardized frontend env vars on `PUBLIC_SUPABASE_URL` and `PUBLIC_SUPABASE_ANON_KEY` (SvelteKit public env convention).","Added Vercel static deploy support for the new frontend, including SPA deep-link fallback via `frontend/vercel.json` and documented deployment steps in `frontend/README.md`."],"timestamp":"2026-02-03T10:00:00Z"}
{"name":"ultimate_design_default_scope_locked","entityType":"decision","observations":["Default scope for PRD/spec conversations is now the intended (ultimate) design, not the current repo state.","When current implementation details are referenced, they are treated as legacy evidence only unless explicitly stated otherwise.","Goal: prevent drift caused by treating incomplete repo artifacts as authoritative design."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"ingestion_two_track_confirmed_doclingdocument_vs_mdast","entityType":"architecture","observations":["Confirmed the ingestion architecture is a hybrid two-track pipeline based on upload type.","Non-Markdown uploads (docx/pptx/pdf/html/images/xlsx/â€¦): `source bytes -> Docling conversion -> DoclingDocument (JSON) -> block extraction`.","Markdown uploads (.md): `markdown bytes -> remark -> mdast -> block extraction`.","Rationale: mdast provides precise source offsets for Markdown; DoclingDocument preserves rich object categories (tables/pictures/headers/footnotes/forms/furniture) that are often lost when forcing everything through Markdown first.","This is a significant shift away from the earlier 'Markdown is the universal pivot' assumption (Docling -> Markdown -> mdast) for non-Markdown formats."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"legacy_markdown_pivot_for_non_md_reclassified","entityType":"decision","observations":["Earlier entries describing non-MD ingest as `Docling -> Markdown -> mdast -> blocks` are now considered legacy/obsolete design framing.","Remark/mdast is still valid and preferred for native Markdown uploads, but it is no longer mandatory as the universal representation for all formats.","DoclingDocument is now treated as an AST-like structured model that can directly support 'typed, ordered, end-to-end' block extraction for non-Markdown sources."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"immutable_envelope_vnext_naming_convention_canonicalized","entityType":"decision","observations":["Introduced and standardized the vNext immutable naming convention: `source_*` (pre-conversion), `conv_*` (post-conversion representation used to derive blocks), `block_*` (per-block immutable registry).","Legacy terms `doc_uid`, `md_uid`, `char_span`, `section_path`, and `annotation` are now explicitly treated as legacy naming only.","Canonical vNext envelope shape per exported block: `{ \"immutable\": { \"source_upload\": {â€¦}, \"conversion\": {â€¦}, \"block\": {â€¦} } }`.","The vNext immutable schema is unified across both ingestion tracks; it must be a normalized superset capable of representing both mdast-derived and DoclingDocument-derived blocks."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"conv_uid_definition_updated_to_match_converted_representation","entityType":"architecture","observations":["Defined `conversion.conv_uid` as the identity hash of the converted representation bytes that were parsed to produce the block inventory (not the uploaded source bytes).","Defined `conversion.conv_representation_type` as an explicit label to prevent hash drift, e.g. `markdown_bytes`, `doclingdocument_json`, `pandoc_ast_json`.","Deterministic formula: `conv_uid = sha256(conv_parsing_tool + \"\\n\" + conv_representation_type + \"\\n\" + conv_representation_bytes)` where `\"\\n\"` is a literal newline separator.","Block locators are tool-specific pointers back into the converted representation (offset ranges for Markdown; JSON pointers/refs for DoclingDocument; AST paths for Pandoc AST if used)."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"immutable_fields_doc_promoted_as_current_reference","entityType":"milestone","observations":["Promoted `docs/product-defining/immutable-fields.md` as the current vNext reference for the immutable envelope fields (role, definitions, data types, and deterministic hash rules).","Consolidated the previously-discussed immutable field table into `docs/product-defining/immutable-fields.md` in clean Markdown (removing HTML-entity artifacts and legacy drift).","Readers should use this doc as the canonical source for vNext field names and meanings while other docs are still being reconciled."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"core_features_and_purpose_intro_refreshed_to_match_vnext","entityType":"milestone","observations":["Updated the first portion of `core features and purpose.md` to align with confirmed design: two-track ingestion, vNext immutable naming, and block-type inventories for DoclingDocument vs mdast.","Inserted a hard stop marker (`======stopâ€"----------`) to clearly separate the refreshed intro from downstream illustrative sections, so future edits do not accidentally drift or overwrite the rest of the document.","Primary docs to read for the current direction: `core features and purpose.md` (intro), `docs/product-defining/immutable-fields.md` (vNext immutable), and the block type tables embedded in `core features and purpose.md`."],"timestamp":"2026-02-07T00:00:00Z"}
{"name":"v2_prd_doc_suite_finalized","entityType":"milestone","observations":["Finalized the v2.0 product-defining document suite under `docs/product-defining-v2.0/`.","Seven canonical docs: `0207-prd-doc1.md` (PRD vision/capabilities/users/success criteria), `0207-prd-tech-spec-doc2.md` (canonical output contract Sections 1-10), `0207-immutable-fields.md` (field definitions + pairing rules + locator schemas), `0207-blocks.md` (block types + hybrid extraction + Docling pipeline), `0207-defining-user-defined-schemas.md` (UC1-4 with full schema artifacts and concrete exports), `0207-db-status-check.md` (v1 DB snapshot for comparison), `0207-assessment+feedback+response.md` (risk assessment + product direction notes).","These docs supersede all earlier PRD/spec documents. Any prior doc using legacy naming (doc_uid, md_uid, char_span, section_path, annotation) is considered legacy only."],"timestamp":"2026-02-07T12:00:00Z"}
{"name":"v2_db_parallel_tables_created","entityType":"milestone","observations":["Applied migration 003: created `documents_v2` and `blocks_v2` tables alongside v1 for structural comparison.","documents_v2 implements full v2 schema: `source_uid` PK, `conv_uid` (replaces legacy `doc_uid`), `conv_parsing_tool`, `conv_representation_type`, `conv_status`, `conv_total_blocks`, `conv_block_type_freq` JSONB, `conv_total_characters`, `source_filesize`, `source_total_characters`. Pairing rules enforced via cross-field CHECK constraint.","blocks_v2 implements: `block_uid` as `conv_uid:block_index` (not hex hash), `block_locator` JSONB typed object (replaces `char_span` integer array), `block_content` (replaces `content_original`), `section_path` removed.","Migrated 3 documents and 563 blocks from v1 with data transformations: `code` block_type mapped to `code_block`, `char_span` converted to `{\"type\":\"text_offset_range\",\"start_offset\":N,\"end_offset\":N}`, `conv_*` fields computed from v1 data."],"timestamp":"2026-02-08T02:21:00Z"}
{"name":"v2_db_phase2_tables_rpc_rls_cron","entityType":"milestone","observations":["Applied migration 004: created `runs_v2` (replaces `annotation_runs`) and `block_overlays_v2` (replaces `block_annotations`) with v2 naming and FKs to v2 tables.","runs_v2 adds `model_config` JSONB column (new in v2 for tracking AI model per run) and uses `conv_uid` FK instead of legacy `doc_uid`.","block_overlays_v2 uses `overlay_jsonb` (becomes `user_defined.data` at export) instead of legacy `annotation_jsonb`, with block_uid FK to blocks_v2.","Created `create_run_v2(p_owner_id, p_conv_uid, p_schema_id)` RPC with `SET search_path = ''` — validates document ownership and ingested status, atomically inserts run + pending overlay rows.","RLS SELECT-only policies on all 4 v2 tables (owner-gated). No write policies (service role only).","Added pg_cron job `stale_conversion_cleanup_v2` for documents_v2 (runs every minute).","Fixed `set_updated_at` function search_path security advisory.","Migrated 1 run and 347 block_annotations from v1, remapping block_uid from hex to conv_uid:index format."],"timestamp":"2026-02-08T02:42:00Z"}
{"name":"v2_db_migration_checklist_created","entityType":"decision","observations":["Created `docs/product-defining-v2.0/0207-v2-database-migration-checklist.md` — comprehensive 9-step checklist tracking all remaining v1-to-v2 migration work.","Steps 1-6 (DB schema + RPC + RLS + cron) are complete. Steps 7-9 remain.","Step 7: Edge Function cutover (5 functions must switch from v1 to v2 tables). Step 8: Smoke test updates (4 scripts). Step 9: Final cutover decision (parallel vs full rename).","schemas table is shared between v1 and v2 (no separate v2 version needed).","All 4 migration files are synced between repo (`supabase/migrations/`) and live Supabase DB."],"timestamp":"2026-02-08T02:50:00Z"}
{"name":"v2_db_current_table_inventory","entityType":"architecture","observations":["v2 tables live in Supabase: documents_v2 (3 rows), blocks_v2 (563 rows), runs_v2 (1 row), block_overlays_v2 (347 rows), schemas (1 row, shared).","v1 tables retained for comparison: documents (3), blocks (563), annotation_runs (1), block_annotations (347).","RPC functions: create_run_v2 (v2, secure), create_annotation_run (v1, legacy), set_updated_at (fixed).","pg_cron: 2 jobs (stale_conversion_cleanup for v1, stale_conversion_cleanup_v2 for v2).","Security: 1 remaining advisory (create_annotation_run search_path — v1 legacy). Leaked password protection disabled (Auth config, not DB)."],"timestamp":"2026-02-08T02:50:00Z"}
{"name":"v2_edge_functions_cutover_step7","entityType":"milestone","observations":["Completed Step 7 of v1-to-v2 migration: all 5 Edge Functions now read/write v2 tables exclusively.","Updated `_shared/markdown.ts`: BlockDraft type changed to v2 fields (start_offset/end_offset/block_content), block_type mapping normalized to v2 enum (code->code_block, thematicBreak->divider, footnoteDefinition->footnote, html->html_block, blockquote/unknown->other), removed section_path.","Updated `ingest/index.ts`: writes to documents_v2 + blocks_v2, computes conv_uid via v2 formula (sha256 of 'mdast\\nmarkdown_bytes\\n' + bytes), block_uid as conv_uid:index (not SHA256), block_locator as JSONB, populates all conv_* fields, removed immutable_schema_ref requirement, response returns conv_uid instead of doc_uid.","Updated `conversion-complete/index.ts`: writes to documents_v2 + blocks_v2, same v2 conv_uid/block_uid/block_locator pattern, populates all conv_* fields. Note: still uses mdast track for non-MD (true Docling JSON track is future work).","Updated `runs/index.ts`: accepts conv_uid instead of doc_uid, calls create_run_v2 RPC, accepts optional model_config (UPDATE after RPC), returns run_id + total_blocks.","Updated `export-jsonl/index.ts`: reads from v2 tables, accepts conv_uid instead of doc_uid, emits v2 canonical shape { immutable: { source_upload, conversion, block }, user_defined: { schema_ref, schema_uid, data } }.","schemas/index.ts unchanged (schemas table shared between v1 and v2).","All 4 modified functions deployed to Supabase (ingest v8, conversion-complete v4, runs v6, export-jsonl v8). All ACTIVE.","Breaking API changes: ingest no longer requires immutable_schema_ref, returns conv_uid not doc_uid; runs accepts conv_uid not doc_uid; export-jsonl accepts conv_uid not doc_uid, output shape changed from {immutable:{envelope,content},annotation} to {immutable:{source_upload,conversion,block},user_defined}.","Steps 1-7 complete. Steps 8-9 remain (smoke test updates + final cutover decision)."],"timestamp":"2026-02-08T04:00:00Z"}
{"name":"v2_smoke_tests_updated_step8","entityType":"milestone","observations":["Completed Step 8 of v1-to-v2 migration: all 4 smoke test scripts updated to validate v2 tables, field names, block_type enum, and canonical export shape.","smoke-test.ps1: removed immutable_schema_ref from ingest call, doc_uid->conv_uid, v2 export shape validation (immutable.source_upload, .conversion, .block, user_defined), pairing rule checks (mdast/markdown_bytes/text_offset_range).","smoke-test-schema-run.ps1: conv_uid in run creation body (was doc_uid), user_defined.schema_ref/.schema_uid/.data (was annotation.*), v2 immutable structure validation.","smoke-test-gfm-blocktypes.ps1: conv_uid instead of doc_uid, block_type path immutable.block.block_type (was immutable.envelope.block_type), required types updated: code_block (was code), footnote (was footnote_definition).","smoke-test-non-md.ps1: removed ImmutableSchemaRef param, polls documents_v2 (was documents), conv_uid (was doc_uid), v2 export shape + pairing rule validation. Note: non-MD still uses mdast track (true Docling track is future work).","Steps 1-8 complete. Step 9 remains (final cutover decision: parallel mode vs full rename)."],"timestamp":"2026-02-08T04:30:00Z"}
{"name":"v2_cutover_complete_step9","entityType":"milestone","observations":["Completed Step 9 (Option A: parallel mode) — v1-to-v2 database migration is COMPLETE.","Migration 005 applied: reject_v1_writes() trigger freezes all 4 v1 tables (documents, blocks, annotation_runs, block_annotations). Any INSERT/UPDATE/DELETE raises exception. Data retained read-only.","v1 cron job (stale_conversion_cleanup) removed — nothing writes to v1 documents anymore. Only v2 cron job remains.","v1 RPC create_annotation_run dropped — resolves the last DB security advisory (function_search_path_mutable). Only create_run_v2 + set_updated_at remain.","Security advisories now 0 DB-level. Only auth_leaked_password_protection remains (Supabase Auth dashboard setting, not a DB change).","5 migration files in repo, all synced with live DB: 001 (phase1), 002 (phase2), 003 (v2 tables), 004 (v2 phase2 + RPC + cron), 005 (freeze v1).","All 9 steps complete. v2 tables are the single source of truth. v1 tables are frozen read-only artifacts."],"timestamp":"2026-02-08T05:00:00Z"}
{"name":"docling_track_implemented","entityType":"milestone","observations":["Implemented the Docling ingestion track for non-Markdown uploads (docx/pdf) per spec pairing rules: docling → doclingdocument_json → docling_json_pointer.","Created `_shared/docling.ts`: parses DoclingDocument JSON, traverses body.children[] + furniture.children[], resolves $ref pointers, maps Docling labels to platform block_type enum, returns blocks with pointer + page_no.","Updated `ingest/index.ts` (v9): always creates docling_output signed URLs for docx/pdf (removed ENABLE_DOCLING_DEBUG_EXPORT env flag gate). txt still gets null.","Updated `conversion-service/app/main.py`: deterministic JSON serialization (sort_keys=True, compact separators) for hash-stable conv_uid. Callback now includes docling_key field.","Updated `conversion-complete/index.ts` (v5): two-branch logic — docling track when docling_key present (conv_parsing_tool=docling, block_locator.type=docling_json_pointer), mdast fallback when absent (txt/legacy).","Updated smoke test and README to document new contract. Test fixture lorem_ipsum.docx added.","Conversion service (Cloud Run) needs separate redeployment for end-to-end. Edge Functions gracefully fall back to mdast track until then.","State log: docs/product-defining-v2.0/0208-docling-track-state-log.md"],"timestamp":"2026-02-08T06:00:00Z"}
